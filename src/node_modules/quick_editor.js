const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

module.exports = quick_editor

async function quick_editor (opts) {
  // ----------------------------------------
  let init
  let data
  const current_data = {}

  const { sdb, io, net } = await get(opts.sid)
  const { drive } = sdb

  const on = {
    style: inject
  }
  // ----------------------------------------
  const el = document.createElement('div')
  el.classList.add('quick-editor')
  const shadow = el.attachShadow({mode: 'closed'})

  shadow.innerHTML = `
      <button class="dots-button">â‹®</button>
      <div class="quick-box">
        <div class="quick-menu hidden">
          <!-- Top Tabs -->
          <div class="top-btns">
          </div>
          <div class="top-tabs">
          </div>
          <button class="apply-button">Apply</button>
        </div>
      </div>
      <style>
      </style>
      `

  const style = shadow.querySelector('style')
  const menu_btn = shadow.querySelector('.dots-button')
  const menu = shadow.querySelector('.quick-menu')
  const textarea = shadow.querySelector('textarea')
  const apply_btn = shadow.querySelector('.apply-button')
  const top_btns = shadow.querySelector('.top-btns')
  const top_tabs = shadow.querySelector('.top-tabs')
  // ----------------------------------------
  // EVENTS
  // ----------------------------------------
  await sdb.watch(onbatch)
  menu_btn.onclick = menu_click
  apply_btn.onclick = apply

  io.on(port => {
    const { by, to } = port
    port.onmessage = event => {
      const txt = event.data
      const key = `[${by} -> ${to}]`
      data = txt
    }
  })
  const port = await io.at(net.page.id)
  
  return el

  // ----------------------------------------
  // FUNCTIONS
  // ----------------------------------------
  function make_btn (name, classes) {
    const btn = document.createElement('button')
    btn.textContent = name
    btn.classList.add(...classes.split(' '))
    btn.setAttribute('tab', name)
    return btn
  }
  function make_tab (id, classes) {
    const tab = document.createElement('div')
    tab.classList.add(...classes.split(' '))
    tab.id = id.replaceAll('.', '')
    tab.innerHTML = `
      <div class="sub-btns">
      </div>
      <div class="subtab-content">
      </div>
    `
    return tab
  }
  function make_textarea (id, classes, value) {
    const textarea = document.createElement('textarea')
    textarea.id = id.replaceAll('.', '')
    textarea.classList.add(...classes.split(' '))
    textarea.value = value
    textarea.placeholder = 'Type here...'
    return textarea
  }
  async function menu_click () {
    menu.classList.toggle('hidden')
    if(init)
      return
    init = true
    Object.entries(data).forEach(([dataset, files], i) => {
      let first = ''
      if(!i){
        first = ' active'
        current_data.dataset = dataset
      }
      const no_slash = dataset.split('/')[0]
      const btn = make_btn(no_slash, `tab-button${first}`)
      const tab = make_tab(no_slash, `tab-content${first}`)

      btn.onclick = () => tab_btn_click(btn, top_btns, top_tabs, '.tab-content', 'dataset', dataset)
      
      top_btns.append(btn)
      top_tabs.append(tab)

      const sub_btns = tab.querySelector('.sub-btns')
      const subtab = tab.querySelector('.subtab-content')
      Object.entries(files).forEach(([file, raw], j) => {
        let first = ''
        if(!j){
          first = ' active'
          current_data.file = file
        }
        const sub_btn = make_btn(file, `sub-btn${first}`)
        const textarea = make_textarea(file, `subtab-textarea${first}`, raw)

        sub_btn.onclick = () => tab_btn_click(sub_btn, sub_btns, subtab, '.subtab-textarea', 'file', file)

        sub_btns.append(sub_btn)
        subtab.append(textarea)
      })
    })
  }
  function tab_btn_click (btn, btns, tabs, tab_class, key, name) {
    btns.querySelector('.active').classList.remove('active')
    tabs.querySelector(tab_class+'.active').classList.remove('active')

    btn.classList.add('active')
    tabs.querySelector('#'+btn.getAttribute('tab').replaceAll('.', '')).classList.add('active')
    current_data[key] = name

  }

  function apply() {
    port.postMessage({ type: 'put', args: [
      current_data.dataset + current_data.file,
      shadow.querySelector('.tab-content.active textarea.active').value
    ]})
  }
  
  function inject (data) {
    style.textContent = data.join('\n')
  }
  async function onbatch(batch) {
    for (const { type, paths } of batch){
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      const func = on[type] || fail
      func(data, type)
    }
  }

  function fail(data, type) { throw new Error('invalid message', { cause: { data, type } }) }

}


function fallback_module(){
  return {
    api: fallback_instance
  }
  function fallback_instance(){
    return {
      drive: {
        'style/': {
          'quick_editor.css': {
            raw: `
            .dots-button {
              border: none;
              font-size: 24px;
              cursor: pointer;
              line-height: 1;
              background-color: white;
              letter-spacing: 1px;
              padding: 3px 5px;
              border-radius: 20%;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }

            .quick-menu {
              position: absolute;
              top: 100%;
              right: 0;
              background: white;
              padding: 8px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.15);
              white-space: nowrap;
              z-index: 10;
              width: 400px;
            }

            .hidden {
              display: none;
            }

            .top-btns {
              display: flex;
              margin-bottom: 8px;
            }

            .tab-button {
              flex: 1;
              padding: 6px 10px;
              background: #eee;
              border: none;
              cursor: pointer;
              border-bottom: 2px solid transparent;
            }
            .tab-button.active {
              background: white;
              border-bottom: 2px solid #4CAF50;
            }
            .tab-content {
              display: none;
            }
            .tab-content.active {
              display: block;
            }

            .sub-btns {
              float: right;
              display: flex;
              flex-direction: column;
              gap: 4px;
              margin-left: 5px;
            }

            .sub-btn {
              padding: 4px 8px;
              background: #f1f1f1;
              border: none;
              cursor: pointer;
              text-align: right;
            }
            .sub-btn.active {
              background: #d0f0d0;
            }

            .subtab-content {
              overflow: hidden;
            }

            .subtab-textarea {
              width: 300px;
              height: 400px;
              display: none;
              resize: vertical;
            }
            .subtab-textarea.active {
              display: block;
            }

            .apply-button {
              display: block;
              margin-top: 10px;
              padding: 5px 10px;
              background-color: #4CAF50;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            }

            `
          }
        }
      }
    }
  }
}